<!DOCTYPE html>
<html>

<head>
    <title>Lab 3</title>
</head>

<body>
    <script src='https://d3js.org/d3.v7.min.js'></script>
    <script>
        class Chart {
            constructor() {
                // Set Dimensions
                Chart.X_SIZE = 1550;
                Chart.Y_SIZE = 750;
                Chart.X_MARGIN = 350;
                Chart.Y_MARGIN = 50;

                Chart.X_MAX = Chart.X_SIZE - Chart.X_MARGIN * 2;
                Chart.Y_MAX = Chart.Y_SIZE - Chart.Y_MARGIN * 2;
                Chart.STROKE_WIDTH = 3.5;
                Chart.STROKE_WIDTH_ON_HOVER = 6.5
                // Append SVG Object to the Page
                Chart.svg = d3.select("body")
                    .append("svg")
                    .attr('width', Chart.X_SIZE)
                    .attr('height', Chart.Y_SIZE)
                    .append("g")
                    .attr("transform", "translate(" + Chart.X_MARGIN + "," + Chart.Y_MARGIN + ")");



                Chart.svg.append("text")
                    .attr("transform", "translate(" + (Chart.X_MAX) / 2 + "," + -20 + ")")
                    .attr("font-size", "24px")
                    .text("COVID-19 cases over time")
                    .style("text-anchor", "middle");

                // Create extents with opposite extents, so that the first read dataset's extents
                // are used instead.
                var xExtent = [new Date(8640000000000000), new Date(0)];
                var yExtent = [Infinity, 0];

                // X Axis
                var x = d3.scaleTime()
                    .domain([xExtent[0], xExtent[1]])
                    .range([0, Chart.X_MAX]);
                Chart.svg.append("g")
                    .attr("class", "bottom_axis")
                    .call(d3.axisBottom(x))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("x", Chart.Y_MAX / 2)
                    .attr("y", -25)
                    .attr("dy", "-5.1em")
                    .attr("text-anchor", "middle")
                    .attr("stroke", "black")
                    .text("Covid Cases");

                // Y Axis
                var y = d3.scaleLinear()
                    .domain([yExtent[0], yExtent[1]])
                    .range([Chart.Y_MAX, 0]);
                Chart.svg.append("g")
                    .attr("class", "left_axis")
                    .call(d3.axisLeft(y))
                    .append("text")
                    .attr("y", Chart.Y_MAX + 40)
                    .attr("x", Chart.X_MAX / 2)
                    .attr("text-anchor", "middle")
                    .attr("stroke", "black")
                    .text("Date");
            }



            draw_line(data, colorScale, onClickFunction) {

                var [x, y] = this.get_axis_scales(data);
                this.update_axis(x, y);
                this.update_lines(data, x, y, colorScale, onClickFunction);

                this.update_legend(data, colorScale, onClickFunction);
            }

            get_axis_scales(data) {
                //Get extents of data
                var flattened_data = [].concat.apply([], data.map(e => e.values));
                var xExtent = d3.extent(flattened_data, d => new Date(d.date))
                var yExtent = d3.extent(flattened_data, d => parseInt(d.total_cases));


                // X Axis
                var x = d3.scaleTime()
                    .domain([xExtent[0], xExtent[1]])
                    .range([0, Chart.X_MAX]);

                // Y Axis
                var y = d3.scaleLinear()
                    .domain([yExtent[0], yExtent[1]])
                    .range([Chart.Y_MAX, 0]);

                return [x, y];
            }

            update_axis(x, y) {
                Chart.svg.select("g .bottom_axis")
                    .attr("transform", "translate(0," + Chart.Y_MAX + ")")
                    .call(d3.axisBottom(x)
                        .tickFormat(d3.timeFormat("%m-%Y")))
                Chart.svg.select("g .left_axis")
                    .call(d3.axisLeft(y));
            }

            update_lines(data, x, y, colorScale, onClickFunction) {
                var line = Chart.svg.selectAll(".line")

                // Add the line
                line
                    .data(data)
                    .join(
                        function (enter) {
                            return enter.append("path")
                                .attr("class", "line")
                                .attr("fill", "none")
                                .attr("stroke-width", Chart.STROKE_WIDTH)
                                .attr("d", function (d) {
                                    return d3.line()
                                        .x(d => x(new Date(d.date)))
                                        .y(d => y(d.total_cases))
                                        (d.values)
                                })
                                .attr("stroke", d => colorScale(d.key))
                                .on("click", function (d, i) {
                                    onClickFunction(i.key) //All elements have same location, being the continent.
                                })
                                .on("mouseover", function (m, s) {

                                    var hoveredLine = d3.select(this);
                                    const ORIGINAL_COLOR = hoveredLine.attr("stroke");
                                    const ORIGINAL_STROKE_WIDTH = hoveredLine.attr("stroke-width");

                                    Chart.svg.selectAll(".line")
                                        .attr("stroke", (d) => d.key == s.key ? ORIGINAL_COLOR : "#f1f1f1")
                                        .attr("stroke-width", (d) => d.key == s.key ? Chart.STROKE_WIDTH_ON_HOVER : ORIGINAL_STROKE_WIDTH)
                                    Chart.svg.selectAll(".legendText")
                                        .style("fill", (d) => d.key == s.key ? "black" : "#f1f1f1")
                                        .style("font-weight", (d) => d.key == s.key ? "bold" : "normal")

                                    Chart.svg.selectAll(".legendCircle").style("fill", (d) => d.key == s.key ? ORIGINAL_COLOR : "#f1f1f1")

                                })
                                .on("mouseout", function () {
                                    //Reset all line colors
                                    Chart.svg.selectAll(".line")
                                        .attr("stroke-width", Chart.STROKE_WIDTH)
                                        .attr("stroke", (d, i) => colorScale(d.key));
                                    Chart.svg.selectAll(".legendText")
                                        .style("fill", "black")
                                        .style("font-weight", "normal");
                                    Chart.svg.selectAll(".legendCircle").style("fill", (d, i) => colorScale(d.key));
                                })
                        },
                        function (update) {
                            return update
                                .attr("d", function (d) {
                                    return d3.line()
                                        .x(d => x(new Date(d.date)))
                                        .y(d => y(d.total_cases))
                                        (d.values)
                                }).attr("stroke", (d, i) => colorScale(i));
                        },
                        function (exit) {
                            return exit
                                .transition()
                                .duration(1000)
                                .attr("stroke", "white")
                                .remove();
                        })
            }

            update_legend(data, colorScale, onClickFunction) {
                const SPACE_OF_ELEMENTS = 5;
                const NUMBER_OF_ELEMENTS_PER_COLUMN = 30;
                const SPACE_BETWEEN_ROWS = 20;
                const SPACE_BETWEEN_COLUMNS = 150;
                const CIRCLE_HORZ_OFFSET = 30;
                const TEXT_HORZ_OFFSET = 40;
                const CIRCLE_RADIUS = 6;
                const MAX_LABEL_LENGTH = 15;
                var circleColumnCounter = -1;
                var textColumnCounter = -1;

                var legend = Chart.svg
                    .selectAll('g.legend')
                    .data(data, d => d.key)
                    .join(
                        function (enter) {

                            var legend_element_container =
                                enter.append("g")
                                    .attr("class", "legend")
                                    .on("mouseover", function (m, s) {

                                        var hoveredLine = d3.select(this).select("circle");
                                        const ORIGINAL_COLOR = hoveredLine.style("fill");
                                        const ORIGINAL_STROKE_WIDTH = hoveredLine.attr("stroke-width");

                                        var sel = Chart.svg.selectAll(".line")
                                            .attr("stroke", (d) => d.key == s.key ? ORIGINAL_COLOR : "#f1f1f1")
                                            .attr("stroke-width", (d) => d.key == s.key ? Chart.STROKE_WIDTH_ON_HOVER : Chart.STROKE_WIDTH)
                                        Chart.svg.selectAll(".legendText")
                                            .style("fill", (d) => d.key == s.key ? "black" : "#f1f1f1")
                                            .style("font-weight", (d) => d.key == s.key ? "bold" : "normal")

                                        Chart.svg.selectAll(".legendCircle").style("fill", (d) => d.key == s.key ? ORIGINAL_COLOR : "#f1f1f1")

                                    })
                                    .on("mouseout", function () {
                                        //Reset all line colors
                                        Chart.svg.selectAll(".line")
                                            .attr("stroke-width", Chart.STROKE_WIDTH)
                                            .attr("stroke", (d, i) => colorScale(d.key));
                                        Chart.svg.selectAll(".legendText")
                                            .style("fill", "black")
                                            .style("font-weight", "normal");
                                        Chart.svg.selectAll(".legendCircle").style("fill", (d, i) => colorScale(d.key));
                                    })
                                    .on("click", function (d, i) {
                                        onClickFunction(i.key)
                                    })

                            legend_element_container.append("circle")
                                .attr("class", "legendCircle")
                                .attr("cx", (d, i) => {
                                    circleColumnCounter = ((i) % NUMBER_OF_ELEMENTS_PER_COLUMN == 0) ? circleColumnCounter + 1 : circleColumnCounter;
                                    return Chart.X_MAX + CIRCLE_HORZ_OFFSET + (circleColumnCounter * SPACE_BETWEEN_COLUMNS);
                                })
                                .attr('cy', (d, i) => {
                                    var rotating_index = (i) % NUMBER_OF_ELEMENTS_PER_COLUMN;
                                    return ((rotating_index) * SPACE_BETWEEN_ROWS + (Chart.Y_MAX / 2) - data.length * SPACE_OF_ELEMENTS)
                                })
                                .attr("r", CIRCLE_RADIUS)
                                .style("fill", d => colorScale(d.key))
                            legend_element_container.append("text")
                                .attr("class", "legendText")
                                .attr("x", (d, i) => {
                                    textColumnCounter = ((i) % NUMBER_OF_ELEMENTS_PER_COLUMN == 0) ? textColumnCounter + 1 : textColumnCounter;
                                    return Chart.X_MAX + TEXT_HORZ_OFFSET + (textColumnCounter * SPACE_BETWEEN_COLUMNS);
                                })
                                .attr('y', (d, i) => {
                                    var rotating_index = (i) % NUMBER_OF_ELEMENTS_PER_COLUMN;
                                    return ((rotating_index) * SPACE_BETWEEN_ROWS + CIRCLE_RADIUS + (Chart.Y_MAX / 2) - data.length * SPACE_OF_ELEMENTS)
                                })
                                .attr("text-anchor", "start")
                                .text(d => d.key.length > MAX_LABEL_LENGTH ? d.key.slice(0, MAX_LABEL_LENGTH) + "..." : d.key)
                        },
                        function (exit) {
                            exit.remove()
                        }
                    )

            }
        }

        function displayCovidCasesWorld() {


            var filtered = raw_data.filter(d => d.iso_code == "OWID_WRL");
            var colorScale = d3.scaleOrdinal().domain([0]).range(d3.schemeSet3);

            var continentData = new Map()
            continentData.set("World", filtered)
            var finalData = Array.from(continentData, function (item) {
                return { key: item[0], values: item[1] }
            });
            chart.draw_line(finalData, colorScale, displayCovidCasesPerContinent);

        }

        function displayCovidCasesPerContinent() {

            const ISO_CODES = ["OWID_ASI", "OWID_AFR", "OWID_EUR", "OWID_NAM", "OWID_SAM", "OWID_OCE"];
            const continents = ["Asia", "Africa", "Europe", "North America", "South America", "Oceania"];


            var filtered = raw_data.filter(d => ISO_CODES.includes(d.iso_code));

            var continentCovidDataMap = d3.group(filtered, d => d.iso_code)
            var colorScale = d3.scaleOrdinal().domain([continents]).range(d3.schemeSet3);

            var continentData = new Map()
            for (let i = 0; i < ISO_CODES.length; i++) {
                continentData.set(continents[i], continentCovidDataMap.get(ISO_CODES[i]))
            }

            var finalData = Array.from(continentData, function (item) {
                return { key: item[0], values: item[1] }
            });
            console.log(finalData)
            chart.draw_line(finalData, colorScale, displayCovidCasesPerCountry);

        }

        function displayCovidCasesPerCountry(continent) {

            var filtered = raw_data.filter(d => d.continent == continent);
            var countryCovidDataMap = d3.group(filtered, d => d.location)
            var colorScale = d3.scaleOrdinal().domain([countryCovidDataMap.keys()]).range(d3.schemeSet3);

            var countryData = new Map()
            countryCovidDataMap.forEach(function (val, key) {
                countryData.set(key, val)
            })
            var finalData = Array.from(countryData, function (item) {
                return { key: item[0], values: item[1] }
            });
            chart.draw_line(finalData, colorScale, displayVaccinesGraph)

        }

        function displayVaccinesGraph(continent) {
            console.log("Displaying vaccine graph")
        }
        function displayWeathVsCasesScatterPlot(data) {
            console.log("World");


        }

        d3.csv('https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv')
            .then(function (data) {
                window.chart = new Chart();
                window.raw_data = data; //global data;
            })
            .then(displayCovidCasesWorld)
            .then(displayWeathVsCasesScatterPlot);
    </script>
</body>

</html>